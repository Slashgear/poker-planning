# GitLab CI/CD Configuration for Poker Planning
image: docker.internal.scaleway.com/node:22.16.0-alpine

# Pipeline stages definition
stages:
  - install
  - lint
  - test
  - build
  - docker
  - deploy

# Global cache to speed up builds
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
    - node_modules/

# Global variables
variables:
  PNPM_HOME: ".pnpm-store"
  CI: "true"
  # Scaleway Container Registry
  SCW_REGISTRY: rg.fr-par.scw.cloud
  SCW_NAMESPACE: poker-planning
  DOCKER_IMAGE: $SCW_REGISTRY/$SCW_NAMESPACE/poker-planning
  # Scaleway Serverless Container
  SCW_REGION: fr-par
  SCW_CONTAINER_NAMESPACE_ID: ${SCW_CONTAINER_NAMESPACE_ID}
  # Override team members via env var (comma-separated)
  # VITE_TEAM_MEMBERS: "Alice,Bob,Charlie"

# Default tags for all jobs
default:
  tags:
    - front-website
    - docker

# Job: Install dependencies
install:
  stage: install
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - .pnpm-store/
    expire_in: 1 hour
  only:
    - branches
    - tags
    - merge_requests

# Job: Linting and code verification
lint:
  stage: lint
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
  script:
    - pnpm exec tsc --noEmit
    - pnpm lint
  allow_failure: false
  only:
    - branches
    - tags
    - merge_requests

# Job: E2E tests with Playwright
test:e2e:
  stage: test
  needs: [install]
  image: mcr.microsoft.com/playwright:v1.56.1-noble
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
    - pnpm config set store-dir .pnpm-store
  script:
    # Install dependencies if necessary
    - pnpm install --frozen-lockfile

    # Start SSE server in background
    - pnpm run dev:server &
    - SERVER_PID=$!

    # Start Vite in background
    - pnpm run dev &
    - VITE_PID=$!

    # Wait for servers to start
    - sleep 10

    # Verify that servers are running
    - wget --spider --tries=30 --retry-connrefused http://localhost:3001/state || exit 1
    - wget --spider --tries=30 --retry-connrefused http://localhost:5173 || exit 1

    # Run tests
    - pnpm test

    # Stop servers
    - kill $SERVER_PID $VITE_PID || true
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    reports:
      junit: test-results/junit.xml
    expire_in: 30 days
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  only:
    - branches
    - tags
    - merge_requests

# Job: Production build
build:
  stage: build
  needs: [install, lint]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - tags
    - merge_requests

# Job: Build and push Docker image to Scaleway Registry
docker:build:
  stage: docker
  needs: [build, test:e2e]
  image: docker.internal.scaleway.com/scw/docker:28.3.3-dind
  before_script:
    - docker login $SCW_REGISTRY --username nologin --password $SCW_SECRET_KEY
  script:
    - docker build --target production -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:latest
  only:
    - main

# Job: Build Docker image for tags (with version)
docker:build:tag:
  stage: docker
  needs: [build, test:e2e]
  image: docker.internal.scaleway.com/scw/docker:28.3.3-dind
  before_script:
    - docker login $SCW_REGISTRY --username nologin --password $SCW_SECRET_KEY
  script:
    - docker build --target production -t $DOCKER_IMAGE:$CI_COMMIT_TAG .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_TAG
  only:
    - tags

# Job: Deploy to Scaleway Serverless Container (staging)
deploy:staging:
  stage: deploy
  needs: [docker:build]
  image: docker.internal.scaleway.com/scaleway/cli:latest
  before_script:
    - scw init secret-key=$SCW_SECRET_KEY access-key=$SCW_ACCESS_KEY project-id=$SCW_PROJECT_ID region=$SCW_REGION send-telemetry=false install-autocomplete=false
  script:
    - |
      scw container container update \
        $SCW_STAGING_CONTAINER_ID \
        region=$SCW_REGION \
        registry-image=$DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA \
        redeploy=true
  environment:
    name: staging
    url: $SCW_STAGING_URL
  only:
    - main
  when: manual

# Job: Deploy to Scaleway Serverless Container (production)
deploy:production:
  stage: deploy
  needs: [docker:build:tag]
  image: docker.internal.scaleway.com/scaleway/cli:latest
  before_script:
    - scw init secret-key=$SCW_SECRET_KEY access-key=$SCW_ACCESS_KEY project-id=$SCW_PROJECT_ID region=$SCW_REGION send-telemetry=false install-autocomplete=false
  script:
    - |
      scw container container update \
        $SCW_PRODUCTION_CONTAINER_ID \
        region=$SCW_REGION \
        registry-image=$DOCKER_IMAGE:$CI_COMMIT_TAG \
        redeploy=true
  environment:
    name: production
    url: $SCW_PRODUCTION_URL
  only:
    - tags
  when: manual

# Job: Security audit
security:audit:
  stage: test
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
  script:
    - pnpm audit --audit-level=moderate
  allow_failure: true
  only:
    - schedules
    - main
    - merge_requests

# Job: Dependency update check
dependency:check:
  stage: test
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
  script:
    - pnpm outdated || true
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    expire_in: 7 days
  allow_failure: true
  only:
    - schedules
    - main